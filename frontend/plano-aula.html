{% extends "base.html" %}
{% block title %}Gerar Plano de Aula{% endblock %}
{% block content %}
<div class="plano-aula-container">
    <!-- Sistema de Notificações Toast -->
    <div id="toast-container" class="toast-container"></div>
    
    <!-- Header da página -->
    <header class="page-header">
        <div class="header-content">
            <h1><i class="fas fa-book-open"></i> Gerar Plano de Aula</h1>
            <p>Crie planos de aula personalizados com IA utilizando habilidades BNCC</p>
        </div>
        <div class="header-stats">
            <div class="stat-item">
                <span class="stat-number" id="total-habilidades">0</span>
                <span class="stat-label">Habilidades</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="total-planos">0</span>
                <span class="stat-label">Planos Salvos</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="planos-hoje">0</span>
                <span class="stat-label">Hoje</span>
            </div>
        </div>
    </header>

    <!-- Seção de Geração -->
    <section class="actions-section">
        <div class="form-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-magic"></i>
                </div>
                <div class="card-title">
                    <h2>Novo Plano de Aula</h2>
                    <p>Selecione uma habilidade BNCC para gerar automaticamente</p>
                </div>
            </div>

            <div class="card-content">
                <form id="plano-form" class="modern-form">
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="habilidade">Habilidade BNCC *</label>
                            <select id="habilidade" name="habilidade" required>
                                <option value="">Carregando habilidades...</option>
                            </select>
                            <div id="habilidade-info" class="habilidade-info" style="display: none;"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="componente">Componente Curricular</label>
                            <input type="text" id="componente" name="componente" readonly>
                        </div>
                        <div class="form-group">
                            <label for="ano">Ano Escolar</label>
                            <input type="number" id="ano" name="ano" min="1" max="9" readonly>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="tema">Tema da Aula</label>
                            <input type="text" id="tema" name="tema" readonly>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="objetivos">Objetivos de Aprendizado</label>
                            <textarea id="objetivos" name="objetivos" rows="4" readonly placeholder="Os objetivos serão preenchidos automaticamente quando você selecionar uma habilidade"></textarea>
                        </div>
                    </div>

                    <div class="form-buttons">
                        <button type="submit" class="btn btn-primary btn-block" disabled>
                            <i class="fas fa-magic"></i>
                            Gerar Plano com IA
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- Seção de Resultado -->
    <section id="resultado-section" class="resultado-section" style="display: none;">
        <div class="result-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="card-title">
                    <h2>Plano Gerado</h2>
                    <p>Seu plano de aula personalizado</p>
                </div>
            </div>

            <div class="card-content">
                <div id="resultado-plano" class="plano-content"></div>

                <div class="plano-actions">
                    <button id="btn-download" class="btn btn-primary">
                        <i class="fas fa-download"></i>
                        Baixar PDF
                    </button>
                    <button id="btn-salvar" class="btn btn-secondary">
                        <i class="fas fa-save"></i>
                        Salvar Plano
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Seção de Histórico -->
    <section class="list-section">
        <div class="list-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-history"></i>
                </div>
                <div class="card-title">
                    <h2>Meus Planos Salvos</h2>
                    <p>Histórico de planos de aula criados</p>
                </div>
                <div class="search-box">
                    <input type="text" id="search-planos" placeholder="Buscar plano...">
                    <i class="fas fa-search"></i>
                </div>
            </div>

            <div class="card-content">
                <div id="planos-grid" class="planos-grid">
                    <!-- Planos serão carregados dinamicamente -->
                </div>

                <div class="empty-state" id="empty-planos" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <h3>Nenhum plano salvo</h3>
                    <p>Seus planos de aula aparecerão aqui após serem salvos</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Botão Voltar -->
    <div class="back-section">
        <a href="/dashboard" class="btn btn-back">
            <i class="fas fa-arrow-left"></i>
            Voltar ao Dashboard
        </a>
    </div>
</div>

<!-- Modal de Edição do Plano -->
<div id="modal-editor-plano" class="modal-overlay" style="display: none;">
    <div class="modal-container">
        <div class="modal-header">
            <h2><i class="fas fa-edit"></i> Editar Plano de Aula</h2>
            <button class="modal-close" onclick="fecharModalEditor()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-content">
            <div class="editor-toolbar">
                <button type="button" class="toolbar-btn" onclick="formatarTexto('bold')" title="Negrito">
                    <i class="fas fa-bold"></i>
                </button>
                <button type="button" class="toolbar-btn" onclick="formatarTexto('italic')" title="Itálico">
                    <i class="fas fa-italic"></i>
                </button>
                <button type="button" class="toolbar-btn" onclick="formatarTexto('underline')" title="Sublinhado">
                    <i class="fas fa-underline"></i>
                </button>
                <div class="toolbar-separator"></div>
                <button type="button" class="toolbar-btn" onclick="formatarTexto('insertUnorderedList')" title="Lista">
                    <i class="fas fa-list-ul"></i>
                </button>
                <button type="button" class="toolbar-btn" onclick="formatarTexto('insertOrderedList')" title="Lista Numerada">
                    <i class="fas fa-list-ol"></i>
                </button>
                <div class="toolbar-separator"></div>
                <button type="button" class="toolbar-btn" onclick="formatarTexto('justifyLeft')" title="Alinhar à Esquerda">
                    <i class="fas fa-align-left"></i>
                </button>
                <button type="button" class="toolbar-btn" onclick="formatarTexto('justifyCenter')" title="Centralizar">
                    <i class="fas fa-align-center"></i>
                </button>
                <button type="button" class="toolbar-btn" onclick="formatarTexto('justifyRight')" title="Alinhar à Direita">
                    <i class="fas fa-align-right"></i>
                </button>
            </div>
            <div id="editor-conteudo" class="editor-area" contenteditable="true">
                <!-- Conteúdo do plano será carregado aqui -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="fecharModalEditor()">
                <i class="fas fa-times"></i>
                Cancelar
            </button>
            <button class="btn btn-primary" onclick="salvarPlanoEditado()">
                <i class="fas fa-save"></i>
                Salvar Alterações
            </button>
            <button class="btn btn-success" onclick="baixarPlanoEditado()">
                <i class="fas fa-download"></i>
                Baixar PDF
            </button>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <p>Gerando plano de aula com IA...</p>
    </div>
</div>

<style>
/* Plano de Aula Styles - Seguindo padrão do Dashboard */
.plano-aula-container {
    padding: 0;
    max-width: 100%;
}

.page-header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    padding: 2rem 1.5rem;
    margin: -1.5rem -1.5rem 2rem -1.5rem;
    border-radius: 0 0 20px 20px;
}

.header-content {
    text-align: center;
    margin-bottom: 2rem;
}

.page-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
}

.page-header p {
    font-size: 1.1rem;
    opacity: 0.9;
    margin: 0;
}

.header-stats {
    display: flex;
    justify-content: center;
    gap: 2rem;
    flex-wrap: wrap;
}

.stat-item {
    text-align: center;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    padding: 1rem 1.5rem;
    min-width: 120px;
}

.stat-number {
    display: block;
    font-size: 2rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Actions Section */
.actions-section {
    margin-bottom: 2rem;
}

.form-card, .result-card, .list-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    transition: all 0.3s ease;
    max-width: 1200px;
    margin: 0 auto 2rem auto;
}

.form-card:hover, .result-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
}

/* Planos Grid - Seguindo padrão das habilidades */
.planos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
    opacity: 1;
    transition: opacity 0.3s ease;
}

.planos-grid.loading {
    opacity: 0.7;
}

.plano-card {
    background: white;
    border-radius: 15px;
    border: 2px solid #e1e8ed;
    padding: 1.5rem;
    transition: all 0.3s ease, border-color 0.5s ease;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    min-height: 300px;
    max-height: 400px;
}

.plano-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    border-color: var(--primary);
}

.plano-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.plano-codigo {
    flex: 1;
}

.codigo-badge {
    background: linear-gradient(135deg, var(--primary), #457d97);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-size: 0.9rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
}

.plano-actions {
    display: flex;
    gap: 0.5rem;
}

.action-btn {
    width: 40px;
    height: 40px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    font-size: 1rem;
}

.view-btn {
    background: rgba(23, 162, 184, 0.1);
    color: #17a2b8;
    border: 1px solid rgba(23, 162, 184, 0.2);
}

.edit-btn {
    background: rgba(52, 168, 83, 0.1);
    color: #34a853;
    border: 1px solid rgba(52, 168, 83, 0.2);
}

.download-btn {
    background: rgba(255, 193, 7, 0.1);
    color: #ffc107;
    border: 1px solid rgba(255, 193, 7, 0.2);
}

.delete-btn {
    background: rgba(234, 67, 53, 0.1);
    color: #ea4335;
    border: 1px solid rgba(234, 67, 53, 0.2);
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.view-btn:hover {
    background: #17a2b8;
    color: white;
    border-color: #17a2b8;
}

.edit-btn:hover {
    background: #34a853;
    color: white;
    border-color: #34a853;
}

.download-btn:hover {
    background: #ffc107;
    color: white;
    border-color: #ffc107;
}

.delete-btn:hover {
    background: #ea4335;
    color: white;
    border-color: #ea4335;
}

.plano-info {
    space-y: 1rem;
}

.plano-titulo {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--primary-dark);
    margin-bottom: 1rem;
    line-height: 1.4;
}

.plano-meta {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #666;
    font-size: 0.9rem;
    font-weight: 500;
}

.meta-item i {
    color: var(--primary);
    width: 16px;
}

.plano-description {
    color: #333;
    line-height: 1.6;
    font-size: 0.95rem;
    text-align: justify;
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 10px;
    border-left: 4px solid var(--primary);
}

.card-header {
    background: var(--gray-light);
    padding: 1.5rem;
    border-bottom: 1px solid #e1e8ed;
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.card-icon {
    width: 50px;
    height: 50px;
    background: var(--primary);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.card-title {
    flex: 1;
}

.card-title h2 {
    font-size: 1.3rem;
    color: var(--primary-dark);
    margin: 0 0 0.25rem 0;
}

.card-title p {
    color: #666;
    margin: 0;
    font-size: 0.9rem;
}

.card-content {
    padding: 1.5rem;
}

/* Search Box */
.search-box {
    position: relative;
    margin-left: auto;
}

.search-box input {
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    border: 2px solid #e1e8ed;
    border-radius: 25px;
    width: 250px;
    font-size: 1rem;
}

.search-box input:focus {
    outline: none;
    border-color: var(--primary);
}

.search-box i {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #666;
}

/* Form Styles */
.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    font-weight: 600;
    color: var(--primary-dark);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 0.75rem;
    border: 2px solid #e1e8ed;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--primary);
}

.form-group input[readonly],
.form-group textarea[readonly] {
    background: #f8f9fa;
    color: #6c757d;
}

.form-group textarea {
    resize: vertical;
    font-family: inherit;
}

/* Habilidade Info */
.habilidade-info {
    margin-top: 1rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 10px;
    border-left: 4px solid var(--primary);
    color: var(--primary-dark);
    font-size: 0.9rem;
    line-height: 1.5;
}

/* Buttons */
.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    text-align: center;
    justify-content: center;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-back {
    background: var(--gray-light);
    color: var(--primary-dark);
    border: 1px solid #e1e8ed;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.btn:disabled {
    background: #ccc;
    color: #999;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.btn-block {
    width: 100%;
}

.form-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Sistema de Notificações Toast */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.toast {
    background: white;
    border-radius: 12px;
    padding: 16px 20px;
    min-width: 300px;
    max-width: 400px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    border-left: 4px solid;
    display: flex;
    align-items: center;
    gap: 12px;
    transform: translateX(100%);
    opacity: 0;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.toast.show {
    transform: translateX(0);
    opacity: 1;
}

.toast.success {
    border-left-color: #28a745;
}

.toast.error {
    border-left-color: #dc3545;
}

.toast.warning {
    border-left-color: #ffc107;
}

.toast.info {
    border-left-color: #17a2b8;
}

.toast-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    flex-shrink: 0;
}

.toast.success .toast-icon {
    background: #28a745;
}

.toast.error .toast-icon {
    background: #dc3545;
}

.toast.warning .toast-icon {
    background: #ffc107;
}

.toast.info .toast-icon {
    background: #17a2b8;
}

.toast-content {
    flex: 1;
}

.toast-title {
    font-weight: 600;
    font-size: 14px;
    color: #333;
    margin-bottom: 2px;
}

.toast-message {
    font-size: 13px;
    color: #666;
    line-height: 1.4;
}

.toast-close {
    background: none;
    border: none;
    font-size: 18px;
    color: #999;
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.toast-close:hover {
    color: #666;
}

.toast-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 0 0 12px 12px;
    animation: toast-progress 4s linear forwards;
}

@keyframes toast-progress {
    from { width: 100%; }
    to { width: 0%; }
}

/* Plano Content - Visualização Melhorada */
.plano-content {
    background: linear-gradient(135deg, #f8fcff 0%, #ffffff 100%);
    border-radius: 20px;
    padding: 3rem;
    margin-bottom: 2rem;
    line-height: 1.9;
    color: #2c3e50;
    box-shadow: 0 8px 32px rgba(69, 125, 151, 0.15);
    border: 1px solid rgba(69, 125, 151, 0.1);
    position: relative;
    overflow: hidden;
}

.plano-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    background: linear-gradient(90deg, var(--primary), #20c997, var(--primary));
    border-radius: 20px 20px 0 0;
}

.plano-content h1 {
    color: var(--primary-dark);
    font-size: 2.2rem;
    font-weight: 700;
    margin: 0 0 2rem 0;
    text-align: center;
    background: linear-gradient(135deg, var(--primary), #20c997);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    padding: 1rem 0;
    border-bottom: 3px solid rgba(69, 125, 151, 0.1);
    position: relative;
}

.plano-content h1::before {
    content: '📚';
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    top: -0.5rem;
    font-size: 2rem;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
}

.plano-content h2 {
    color: var(--primary);
    font-size: 1.6rem;
    font-weight: 650;
    margin: 2.5rem 0 1.2rem 0;
    padding: 0.8rem 1.5rem;
    background: linear-gradient(135deg, rgba(69, 125, 151, 0.08), rgba(32, 201, 151, 0.08));
    border-left: 5px solid var(--primary);
    border-radius: 0 15px 15px 0;
    position: relative;
    box-shadow: 0 2px 10px rgba(69, 125, 151, 0.1);
}

.plano-content h2::before {
    content: '▶';
    color: var(--primary);
    margin-right: 0.8rem;
    font-size: 0.9rem;
}

.plano-content h3 {
    color: #34495e;
    margin: 2rem 0 1rem 0;
    font-size: 1.4rem;
    font-weight: 600;
    padding: 0.6rem 0;
    border-bottom: 2px solid rgba(69, 125, 151, 0.2);
    position: relative;
}

.plano-content h3::before {
    content: '🎯';
    margin-right: 0.8rem;
    font-size: 1.1rem;
}

.plano-content p {
    margin-bottom: 1.4rem;
    color: #2c3e50;
    line-height: 1.9;
    text-align: justify;
    text-indent: 1.5rem;
    font-size: 1.05rem;
}

.plano-content p:first-of-type {
    text-indent: 0;
    font-size: 1.1rem;
    color: #34495e;
    font-weight: 500;
}

.plano-content ul, .plano-content ol {
    margin: 1.5rem 0 2rem 2rem;
    color: #2c3e50;
    background: rgba(255, 255, 255, 0.7);
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid rgba(69, 125, 151, 0.1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.plano-content ul::before {
    content: '📝 Lista de itens:';
    display: block;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 0.8rem;
    font-size: 0.95rem;
}

.plano-content ol::before {
    content: '📋 Sequência de atividades:';
    display: block;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 0.8rem;
    font-size: 0.95rem;
}

.plano-content li {
    margin: 0.8rem 0;
    color: #2c3e50;
    line-height: 1.7;
    position: relative;
    padding: 0.3rem 0;
}

.plano-content ul li::marker {
    content: '✦ ';
    color: var(--primary);
    font-size: 1.2rem;
}

.plano-content ol li::marker {
    color: var(--primary);
    font-weight: bold;
}

.plano-content strong {
    color: var(--primary-dark);
    font-weight: 700;
    background: linear-gradient(135deg, rgba(69, 125, 151, 0.1), rgba(32, 201, 151, 0.1));
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
}

.plano-content em {
    color: var(--primary);
    font-style: italic;
    font-weight: 500;
    background: rgba(69, 125, 151, 0.05);
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
}

/* Melhorias para blocos de texto especiais */
.plano-content blockquote {
    background: linear-gradient(135deg, rgba(32, 201, 151, 0.1), rgba(69, 125, 151, 0.05));
    border-left: 5px solid #20c997;
    padding: 1.5rem;
    margin: 2rem 0;
    border-radius: 0 15px 15px 0;
    font-style: italic;
    color: #2c3e50;
    box-shadow: 0 3px 12px rgba(32, 201, 151, 0.1);
}

.plano-content hr {
    border: none;
    height: 3px;
    background: linear-gradient(90deg, transparent, var(--primary), transparent);
    margin: 3rem 0;
    border-radius: 2px;
}

/* Destaque para seções importantes */
.plano-content .destaque,
.plano-content .importante {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.05));
    border: 2px solid rgba(255, 193, 7, 0.3);
    border-radius: 15px;
    padding: 1.5rem;
    margin: 2rem 0;
    position: relative;
}

.plano-content .destaque::before {
    content: '⭐ IMPORTANTE';
    position: absolute;
    top: -12px;
    left: 20px;
    background: #ffc107;
    color: white;
    padding: 0.3rem 1rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
}

/* Animação sutil para elementos interativos */
.plano-content h2:hover,
.plano-content h3:hover {
    transform: translateX(5px);
    transition: transform 0.3s ease;
}

/* Melhor formatação para código ou exemplos */
.plano-content code {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 0.3rem 0.6rem;
    font-family: 'Courier New', monospace;
    color: #e83e8c;
    font-size: 0.9rem;
}

.plano-content pre {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 1.5rem;
    overflow-x: auto;
    margin: 1.5rem 0;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
}

/* Responsividade melhorada */
@media (max-width: 768px) {
    .plano-content {
        padding: 2rem 1.5rem;
        margin: 0 -0.5rem 2rem -0.5rem;
    }
    
    .plano-content h1 {
        font-size: 1.8rem;
    }
    
    .plano-content h2 {
        font-size: 1.4rem;
        padding: 0.6rem 1rem;
        margin: 2rem 0 1rem 0;
    }
    
    .plano-content p {
        text-indent: 0;
        font-size: 1rem;
    }
    
    .plano-content ul,
    .plano-content ol {
        margin-left: 1rem;
        padding: 1rem;
    }
}

.plano-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
}

/* Grid de Planos */
.planos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
}

.plano-card {
    background: white;
    border-radius: 15px;
    border: 2px solid #e1e8ed;
    padding: 1.5rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    cursor: pointer;
}

.plano-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    border-color: var(--primary);
}

.plano-header {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e1e8ed;
}

.plano-titulo {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--primary-dark);
    margin: 0;
    line-height: 1.3;
}

.plano-meta {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 0.5rem;
}

.meta-badge {
    background: rgba(69, 125, 151, 0.1);
    color: var(--primary);
    padding: 0.3rem 0.8rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 500;
}

.plano-data {
    font-size: 0.9rem;
    color: #6b7280;
    display: flex;
    align-items: center;
    gap: 0.3rem;
}

.plano-preview {
    color: var(--primary-dark);
    line-height: 1.5;
    margin-bottom: 1.5rem;
    font-size: 0.95rem;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    flex: 1;
    min-height: 80px;
    max-height: 100px;
    transition: opacity 0.3s ease;
}

.plano-actions {
    display: flex;
    gap: 0.8rem;
    justify-content: space-between;
    margin-top: auto;
}

.plano-actions button {
    flex: 1;
    padding: 0.7rem 1rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
    transition: all 0.3s ease;
}

.btn-visualizar {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.btn-visualizar:hover {
    background: linear-gradient(135deg, #218838, #1da88a);
    transform: translateY(-2px);
}

.btn-download {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
}

.btn-download:hover {
    background: linear-gradient(135deg, #0056b3, #004085);
    transform: translateY(-2px);
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem;
    color: #666;
}

.empty-icon {
    width: 80px;
    height: 80px;
    background: var(--gray-light);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    color: var(--primary);
    font-size: 2rem;
}

.empty-state h3 {
    font-size: 1.5rem;
    margin: 0 0 0.5rem 0;
    color: var(--primary-dark);
}

.empty-state p {
    color: #666;
    font-size: 1rem;
}

/* Back Section */
.back-section {
    text-align: center;
    margin-top: 2rem;
}

/* Loading Overlay */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.loading-content {
    text-align: center;
    color: white;
}

.loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-content p {
    font-size: 1.1rem;
    font-weight: 500;
}

/* Responsividade dos toasts */
@media (max-width: 768px) {
    .toast-container {
        top: 10px;
        right: 10px;
        left: 10px;
    }

    .toast {
        min-width: auto;
        max-width: none;
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .page-header {
        padding: 1.5rem 1rem;
        margin: -1rem -1rem 1.5rem -1rem;
    }

    .page-header h1 {
        font-size: 2rem;
        flex-direction: column;
        gap: 0.5rem;
    }

    .header-stats {
        flex-direction: column;
        gap: 1rem;
    }

    .form-card, .result-card, .list-card {
        margin: 0 0 2rem 0;
    }

    .card-header {
        flex-direction: column;
        align-items: flex-start;
    }

    .search-box {
        margin-left: 0;
        width: 100%;
    }

    .search-box input {
        width: 100%;
    }

    .form-row {
        grid-template-columns: 1fr;
    }

    .planos-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .plano-card {
        padding: 1rem;
    }

    .plano-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }

    .plano-actions {
        align-self: flex-end;
    }

    .plano-meta {
        gap: 1rem;
    }
}

@media (max-width: 480px) {
    .stat-item {
        padding: 0.75rem 1rem;
        min-width: 100px;
    }

    .stat-number {
        font-size: 1.5rem;
    }

    .planos-grid {
        grid-template-columns: 1fr;
    }

    .plano-titulo {
        font-size: 1rem;
    }

    .codigo-badge {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }

    .action-btn {
        width: 35px;
        height: 35px;
        font-size: 0.9rem;
    }

    .meta-item {
        font-size: 0.8rem;
    }

    .plano-description {
        font-size: 0.9rem;
        padding: 0.8rem;
    }
}

/* Modal de Edição */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 20px;
}

.modal-container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    width: 100%;
    max-width: 1200px;
    height: 90vh;
    max-height: 800px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.modal-header {
    background: var(--primary);
    color: white;
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.3rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.modal-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 50%;
    transition: background 0.3s ease;
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

.modal-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.editor-toolbar {
    background: #f8f9fa;
    border-bottom: 1px solid #e1e8ed;
    padding: 0.75rem;
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-wrap: wrap;
}

.toolbar-btn {
    background: white;
    border: 1px solid #e1e8ed;
    border-radius: 6px;
    padding: 0.5rem;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--primary-dark);
}

.toolbar-btn:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.toolbar-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.toolbar-separator {
    width: 1px;
    height: 24px;
    background: #e1e8ed;
    margin: 0 0.5rem;
}

.editor-area {
    flex: 1;
    padding: 2rem;
    font-family: 'Arial', sans-serif;
    font-size: 1rem;
    line-height: 1.6;
    color: var(--primary-dark);
    background: white;
    border: none;
    outline: none;
    overflow-y: auto;
    min-height: 400px;
}

.editor-area:focus {
    outline: none;
}

.editor-area h1, .editor-area h2, .editor-area h3 {
    color: var(--primary);
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
}

.editor-area h1 {
    font-size: 1.8rem;
    border-bottom: 2px solid var(--primary);
    padding-bottom: 0.5rem;
}

.editor-area h2 {
    font-size: 1.5rem;
}

.editor-area h3 {
    font-size: 1.3rem;
}

.editor-area hr {
    border: none;
    border-top: 2px solid var(--primary);
    margin: 2rem 0;
    opacity: 0.5;
}

.editor-area strong:first-child {
    color: var(--primary);
    font-size: 1.1rem;
}

.editor-area em {
    color: #666;
    font-style: italic;
}

.editor-area p {
    margin-bottom: 1rem;
}

.editor-area ul, .editor-area ol {
    margin: 1rem 0;
    padding-left: 2rem;
}

.editor-area li {
    margin: 0.5rem 0;
}

.modal-footer {
    background: #f8f9fa;
    border-top: 1px solid #e1e8ed;
    padding: 1.5rem;
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    flex-wrap: wrap;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #218838;
}

/* Responsividade do Modal */
@media (max-width: 768px) {
    .modal-overlay {
        padding: 10px;
    }
    
    .modal-container {
        max-width: 100%;
        max-height: 95vh;
    }
    
    .modal-header {
        padding: 1rem;
    }
    
    .modal-header h2 {
        font-size: 1.1rem;
    }
    
    .editor-toolbar {
        padding: 0.5rem;
        gap: 0.25rem;
    }
    
    .toolbar-btn {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
    }
    
    .editor-area {
        padding: 1rem;
        font-size: 0.9rem;
    }
    
    .modal-footer {
        padding: 1rem;
        flex-direction: column;
    }
    
    .modal-footer .btn {
        width: 100%;
    }
}

/* List Section */
.list-section {
    max-width: 1200px;
    margin: 0 auto;
}

.resultado-section {
    max-width: 1200px;
    margin: 0 auto;
}
    </style>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="/js/plano-aula.js"></script>
    <script>
        window.userName = "{{ user.user_name|e }}";
        
        // DEBUG GLOBAL - Monitorar todas as chamadas de API
        window.debugAPI = true;
        
        // Interceptar todas as chamadas fetch para debug
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            if (window.debugAPI) {
                console.log('🌐 FETCH INTERCEPTADO:', args);
            }
            return originalFetch.apply(this, args).then(response => {
                if (window.debugAPI) {
                    console.log('📨 FETCH RESPONSE:', response.status, response.url);
                }
                return response;
            }).catch(error => {
                if (window.debugAPI) {
                    console.error('💥 FETCH ERROR:', error);
                }
                throw error;
            });
        };
        
        // Adicionar teste de conectividade da API
        window.testarAPI = async function() {
            try {
                console.log('🧪 TESTANDO conectividade da API...');
                const response = await fetch('/api/planos-aula');
                console.log('📡 Status da API:', response.status);
                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ API funcionando, planos encontrados:', data.planos ? data.planos.length : 0);
                    return true;
                } else {
                    console.error('❌ API retornou erro:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('💥 Erro ao testar API:', error);
                return false;
            }
        };

        // FUNÇÃO DE DEBUG ESPECÍFICA PARA PLANOS
        window.debugPlanos = async function() {
            console.log('🔍 === INICIANDO DEBUG COMPLETO DOS PLANOS ===');
            
            // 1. Testar API
            try {
                const response = await fetch('/api/planos-aula');
                const data = await response.json();
                
                console.log('📦 DADOS BRUTOS DA API:', data);
                
                if (data.planos && data.planos.length > 0) {
                    console.log(`✅ ${data.planos.length} planos encontrados`);
                    
                    // Verificar cada plano individualmente
                    data.planos.forEach((plano, index) => {
                        console.log(`\n📋 PLANO ${index + 1}:`);
                        console.log('  ID:', plano.id, '(tipo:', typeof plano.id, ')');
                        console.log('  Título:', plano.titulo);
                        console.log('  Conteúdo (preview):', plano.conteudo ? plano.conteudo.substring(0, 50) + '...' : 'Sem conteúdo');
                        console.log('  Objeto completo:', plano);
                        
                        // Testar se consegue buscar plano individual
                        console.log(`\n🧪 TESTANDO busca individual do plano ${plano.id}:`);
                        fetch(`/api/planos-aula/${plano.id}`)
                            .then(resp => resp.json())
                            .then(individualData => {
                                console.log(`  ✅ Plano ${plano.id} individual:`, individualData);
                            })
                            .catch(err => {
                                console.error(`  ❌ Erro ao buscar plano ${plano.id}:`, err);
                            });
                    });
                } else {
                    console.log('❌ Nenhum plano encontrado');
                }
            } catch (error) {
                console.error('💥 Erro no debug:', error);
            }
            
            // 2. Verificar elementos DOM
            console.log('\n🔍 VERIFICANDO ELEMENTOS DOM:');
            const modal = document.getElementById('modal-editor-plano');
            console.log('  Modal encontrado:', modal ? 'SIM' : 'NÃO');
            
            const editor = document.getElementById('editor-conteudo');
            console.log('  Editor encontrado:', editor ? 'SIM' : 'NÃO');
            
            // 3. Verificar botões de edição
            const botoes = document.querySelectorAll('.btn-visualizar');
            console.log('  Botões de visualização encontrados:', botoes.length);
            
            if (botoes.length > 0) {
                console.log('  Primeiro botão - onclick:', botoes[0].onclick);
                console.log('  Primeiro botão - data-plano-id:', botoes[0].getAttribute('data-plano-id'));
            }
            
            console.log('\n🔍 === DEBUG COMPLETO FINALIZADO ===');
        };

        // Sistema de Notificações Toast
        function showToast(type, title, message) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            // Criar elemento toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // Definir ícones para cada tipo
            const icons = {
                success: '✓',
                error: '✕',
                warning: '⚠',
                info: 'ℹ'
            };

            toast.innerHTML = `
                <div class="toast-icon">
                    ${icons[type] || 'ℹ'}
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="closeToast(this)">×</button>
                <div class="toast-progress"></div>
            `;

            // Adicionar ao container
            container.appendChild(toast);

            // Mostrar toast com animação
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            // Auto remover após 4 segundos
            setTimeout(() => {
                closeToast(toast);
            }, 4000);
        }

        function closeToast(element) {
            const toast = element.classList ? element : element.closest('.toast');
            if (toast) {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }
        }

        // Funções de conveniência para diferentes tipos de toast
        function showSuccess(title, message = '') {
            showToast('success', title, message);
        }

        function showError(title, message = '') {
            showToast('error', title, message);
        }

        function showWarning(title, message = '') {
            showToast('warning', title, message);
        }

        function showInfo(title, message = '') {
            showToast('info', title, message);
        }
    
        // Inicialização da página
        document.addEventListener('DOMContentLoaded', function() {
            carregarEstatisticas();
            configurarBusca();
            configurarFormulario();
            carregarHabilidades();
            carregarPlanosSalvos();
        });

        // Função para carregar estatísticas
        function carregarEstatisticas() {
            // Carregar habilidades
            fetch('/api/habilidades')
                .then(response => response.json())
                .then(data => {
                    const totalHabilidades = data.habilidades ? data.habilidades.length : 0;
                    animarContador('total-habilidades', totalHabilidades);
                })
                .catch(error => {
                    console.error('Erro ao carregar habilidades:', error);
                    document.getElementById('total-habilidades').textContent = '0';
                    showError('Erro', 'Erro ao carregar estatísticas de habilidades');
                });

            // Simular carregamento de planos (implementar API se necessário)
            animarContador('total-planos', 0);
            animarContador('planos-hoje', 0);
        }

        // Função para animar contadores
        function animarContador(elementId, valorFinal) {
            const elemento = document.getElementById(elementId);
            if (!elemento) return;
            
            const valorInicial = 0;
            const duracao = 1000;
            const incremento = valorFinal / (duracao / 16);
            
            let valorAtual = valorInicial;
            
            const timer = setInterval(() => {
                valorAtual += incremento;
                if (valorAtual >= valorFinal) {
                    elemento.textContent = valorFinal;
                    clearInterval(timer);
                } else {
                    elemento.textContent = Math.floor(valorAtual);
                }
            }, 16);
        }

        // Configurar busca
        function configurarBusca() {
            const searchInput = document.getElementById('search-planos');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const planoCards = document.querySelectorAll('.plano-card');
                    
                    planoCards.forEach(card => {
                        const titulo = card.querySelector('.plano-titulo');
                        if (titulo && titulo.textContent.toLowerCase().includes(searchTerm)) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            }
        }

        // Carregar habilidades do banco
        async function carregarHabilidades() {
            try {
                const response = await fetch('/api/habilidades');
                const data = await response.json();
                
                if (data.habilidades && data.habilidades.length > 0) {
                    const select = document.getElementById('habilidade');
                    select.innerHTML = '<option value="">Selecione uma habilidade BNCC...</option>';
                    
                    data.habilidades.forEach(habilidade => {
                        const option = document.createElement('option');
                        option.value = habilidade.id;
                        option.textContent = `${habilidade.codigo} - ${habilidade.componente} (${habilidade.ano}º ano)`;
                        option.dataset.componente = habilidade.componente;
                        option.dataset.ano = habilidade.ano;
                        option.dataset.codigo = habilidade.codigo;
                        option.dataset.descricao = habilidade.descricao;
                        select.appendChild(option);
                    });
                } else {
                    showWarning('Atenção', 'Nenhuma habilidade encontrada. Cadastre habilidades primeiro.');
                }
            } catch (error) {
                console.error('Erro ao carregar habilidades:', error);
                showError('Erro', 'Erro ao carregar habilidades disponíveis');
            }
        }

        // Carregar planos salvos do banco
        async function carregarPlanosSalvos() {
            try {
                const grid = document.getElementById('planos-grid');
                const emptyState = document.getElementById('empty-planos');
                
                // Mostrar indicador de carregamento
                grid.classList.add('loading');
                emptyState.style.display = 'none';
                
                console.log('🔍 BUSCANDO planos da API...');
                const response = await fetch('/api/planos-aula');
                const data = await response.json();
                
                console.log('📦 RESPOSTA DA API /api/planos-aula:', data);
                console.log('📋 PLANOS RECEBIDOS:', data.planos);
                
                // Verificar IDs dos planos
                if (data.planos && data.planos.length > 0) {
                    console.log('🔍 VERIFICANDO IDs DOS PLANOS:');
                    data.planos.forEach((plano, index) => {
                        console.log(`  Plano ${index + 1}:`, {
                            id: plano.id,
                            tipo_id: typeof plano.id,
                            titulo: plano.titulo,
                            plano_completo: plano
                        });
                    });
                }
                
                // Remover indicador de carregamento
                grid.classList.remove('loading');
                
                if (data.planos && data.planos.length > 0) {
                    preencherCardsPlanos(data.planos);
                    emptyState.style.display = 'none';
                } else {
                    grid.innerHTML = '';
                    emptyState.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro ao carregar planos:', error);
                const grid = document.getElementById('planos-grid');
                const emptyState = document.getElementById('empty-planos');
                
                grid.classList.remove('loading');
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                
                showError('Erro', 'Não foi possível carregar os planos salvos');
            }
        }

        // Preencher cards dos planos
        function preencherCardsPlanos(planos) {
            const grid = document.getElementById('planos-grid');
            grid.innerHTML = '';
            
            if (!planos || planos.length === 0) {
                document.getElementById('empty-planos').style.display = 'block';
                return;
            }
            
            document.getElementById('empty-planos').style.display = 'none';
            
            planos.forEach(plano => {
                const card = document.createElement('div');
                card.className = 'plano-card';
                
                // Melhor formatação de data
                let dataFormatada = 'Data não disponível';
                try {
                    if (plano.created_at || plano.criado_em) {
                        const data = new Date(plano.created_at || plano.criado_em);
                        dataFormatada = data.toLocaleDateString('pt-BR', {
                            day: '2-digit',
                            month: '2-digit', 
                            year: 'numeric'
                        });
                    }
                } catch (e) {
                    console.error('Erro ao formatar data:', e);
                }
                
                // Extrair componente e ano do título se não estiverem disponíveis
                let componenteInfo = plano.componente || 'Geral';
                let anoInfo = plano.ano || '';
                
                if (!componenteInfo || componenteInfo === 'N/A') {
                    // Tentar extrair do título
                    const titulo = plano.titulo || '';
                    if (titulo.includes('Matemática')) componenteInfo = 'Matemática';
                    else if (titulo.includes('Português') || titulo.includes('Língua Portuguesa')) componenteInfo = 'Português';
                    else if (titulo.includes('Ciências')) componenteInfo = 'Ciências';
                    else if (titulo.includes('História')) componenteInfo = 'História';
                    else if (titulo.includes('Geografia')) componenteInfo = 'Geografia';
                    else componenteInfo = 'Plano de Aula';
                    
                    // Extrair ano do título
                    const anoMatch = titulo.match(/(\d+)º\s*ano/i);
                    if (anoMatch) {
                        anoInfo = anoMatch[1];
                    }
                }
                
                // Melhor preview do conteúdo
                let previewTexto = 'Sem prévia disponível';
                if (plano.conteudo) {
                    // Remover markdown e HTML tags para preview limpo
                    let textoLimpo = plano.conteudo
                        .replace(/<[^>]*>/g, '') // Remove HTML
                        .replace(/[#*\-\n]/g, ' ') // Remove markdown básico
                        .replace(/\s+/g, ' ') // Remove espaços múltiplos
                        .trim();
                    
                    if (textoLimpo.length > 150) {
                        previewTexto = textoLimpo.substring(0, 150) + '...';
                    } else {
                        previewTexto = textoLimpo;
                    }
                }
                
                card.innerHTML = `
                    <div class="plano-header">
                        <div class="plano-titulo">${plano.titulo || 'Plano sem título'}</div>
                        <div class="plano-meta">
                            <span class="meta-badge">${componenteInfo}</span>
                            ${anoInfo ? `<span class="meta-badge">${anoInfo}º ano</span>` : ''}
                        </div>
                        <div class="plano-data">
                            <i class="fas fa-calendar"></i>
                            ${dataFormatada}
                        </div>
                    </div>
                    <div class="plano-preview">${previewTexto}</div>
                    <div class="plano-actions">
                        <button class="btn-visualizar" onclick="abrirPlanoEdicao('${plano.id}')" data-plano-id="${plano.id}" data-debug="ID: ${plano.id}, Tipo: ${typeof plano.id}">
                            <i class="fas fa-eye"></i>
                            Visualizar
                        </button>
                        <button class="btn-download" onclick="baixarPlanoPDF('${plano.id}')">
                            <i class="fas fa-download"></i>
                            Download
                        </button>
                    </div>
                `;
                
                grid.appendChild(card);
            });
            
            // Atualizar estatísticas
            atualizarEstatisticas(planos.length);
        }

        // Configurar formulário
        function configurarFormulario() {
            const form = document.getElementById('plano-form');
            const submitBtn = form.querySelector('button[type="submit"]');
            
            // Habilitar botão quando habilidade for selecionada
            document.getElementById('habilidade').addEventListener('change', function() {
                if (this.value) {
                    const selectedOption = this.options[this.selectedIndex];
                    
                    // Preencher campos automaticamente
                    document.getElementById('componente').value = selectedOption.dataset.componente || '';
                    document.getElementById('ano').value = selectedOption.dataset.ano || '';
                    document.getElementById('tema').value = `Plano de Aula - ${selectedOption.dataset.codigo}`;
                    document.getElementById('objetivos').value = selectedOption.dataset.descricao || '';
                    
                    // Mostrar informações da habilidade
                    const infoDiv = document.getElementById('habilidade-info');
                    infoDiv.innerHTML = `
                        <strong>Código:</strong> ${selectedOption.dataset.codigo}<br>
                        <strong>Componente:</strong> ${selectedOption.dataset.componente}<br>
                        <strong>Ano:</strong> ${selectedOption.dataset.ano}º ano<br>
                        <strong>Descrição:</strong> ${selectedOption.dataset.descricao}
                    `;
                    infoDiv.style.display = 'block';
                    
                    submitBtn.disabled = false;
                    showSuccess('Habilidade Selecionada', 'Todos os campos foram preenchidos automaticamente');
                } else {
                    // Limpar campos
                    document.getElementById('componente').value = '';
                    document.getElementById('ano').value = '';
                    document.getElementById('tema').value = '';
                    document.getElementById('objetivos').value = '';
                    document.getElementById('habilidade-info').style.display = 'none';
                    
                    submitBtn.disabled = true;
                }
            });

            // Configurar envio do formulário
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const habilidadeSelecionada = document.getElementById('habilidade').value;
                if (!habilidadeSelecionada) {
                    showWarning('Atenção', 'Selecione uma habilidade BNCC para gerar o plano');
                    return;
                }

                // Mostrar loading
                document.getElementById('loading-overlay').style.display = 'flex';
                
                try {
                    // Preparar dados para envio
                    const selectedOption = document.getElementById('habilidade').options[document.getElementById('habilidade').selectedIndex];
                    const formData = {
                        componente: document.getElementById('componente').value,
                        ano: document.getElementById('ano').value,
                        tema: document.getElementById('tema').value,
                        habilidades: document.getElementById('objetivos').value,
                        objetivos: document.getElementById('objetivos').value
                    };
                    
                    console.log('Enviando dados para gerar plano:', formData);
                    
                    // Fazer chamada para a API
                    const response = await fetch('/gerar-plano', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    const data = await response.json();
                    console.log('Resposta da API:', data);
                    
                    if (data.success) {
                        // Plano gerado com sucesso
                        document.getElementById('loading-overlay').style.display = 'none';
                        
                        // Verificar se há aviso (modo fallback)
                        let avisoHtml = '';
                        if (data.aviso) {
                            avisoHtml = `
                                <div class="alert alert-info" style="background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 8px; padding: 0.8rem; margin-bottom: 1rem; color: #0056b3;">
                                    <i class="fas fa-info-circle"></i> 
                                    <strong>Informação:</strong> ${data.aviso}
                                </div>
                            `;
                        }
                        
                        // Exibir o plano gerado com melhor formatação
                        const resultadoPlano = document.getElementById('resultado-plano');
                        
                        // Adicionar cabeçalho educacional ao plano
                        const cabecalhoPlano = `
                            <div style="text-align: center; margin-bottom: 2rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(69, 125, 151, 0.1), rgba(32, 201, 151, 0.05)); border-radius: 15px; border: 2px solid rgba(69, 125, 151, 0.2);">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="width: 60px; height: 60px; background: linear-gradient(135deg, var(--primary), #20c997); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem;">📚</div>
                                    <div>
                                        <h2 style="margin: 0; color: var(--primary-dark); font-size: 1.8rem;">PLANO DE AULA GERADO</h2>
                                        <p style="margin: 0; color: #666; font-size: 1rem;">Baseado nas Diretrizes da BNCC</p>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
                                    <div style="text-align: center;">
                                        <strong style="color: var(--primary);">📋 Componente:</strong><br>
                                        <span style="color: #2c3e50; font-weight: 600;">${document.getElementById('componente').value}</span>
                                    </div>
                                    <div style="text-align: center;">
                                        <strong style="color: var(--primary);">🎯 Ano Escolar:</strong><br>
                                        <span style="color: #2c3e50; font-weight: 600;">${document.getElementById('ano').value}º ano</span>
                                    </div>
                                    <div style="text-align: center;">
                                        <strong style="color: var(--primary);">📅 Data:</strong><br>
                                        <span style="color: #2c3e50; font-weight: 600;">${new Date().toLocaleDateString('pt-BR')}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        resultadoPlano.innerHTML = `
                            ${avisoHtml}
                            ${cabecalhoPlano}
                            ${formatarPlanoTexto(data.plano)}
                        `;
                        
                        // Mostrar seção de resultado com animação suave
                        const resultadoSection = document.getElementById('resultado-section');
                        resultadoSection.style.display = 'block';
                        resultadoSection.style.opacity = '0';
                        resultadoSection.style.transform = 'translateY(20px)';
                        
                        // Animar entrada
                        setTimeout(() => {
                            resultadoSection.style.transition = 'all 0.6s ease';
                            resultadoSection.style.opacity = '1';
                            resultadoSection.style.transform = 'translateY(0)';
                            resultadoSection.scrollIntoView({ behavior: 'smooth' });
                        }, 100);
                        
                        showSuccess('Sucesso!', `Plano de aula gerado com ${data.tipo === 'ia' ? 'IA' : 'modelo educacional'}`);
                        
                        // Configurar botões de ação
                        configurarBotoesAcao(data.plano, formData);
                        
                    } else {
                        throw new Error(data.error || 'Erro ao gerar plano');
                    }
                    
                } catch (error) {
                    console.error('Erro ao gerar plano:', error);
                    document.getElementById('loading-overlay').style.display = 'none';
                    showError('Erro', `Falha ao gerar plano: ${error.message}`);
                }
            });
        }

        // Funções do Modal Editor - CORRIGIDAS COM PERSISTÊNCIA TOTAL
        // Usar Object.defineProperty para tornar as variáveis verdadeiramente globais e persistentes
        if (typeof window.PLANO_EDITOR_STATE === 'undefined') {
            window.PLANO_EDITOR_STATE = {
                id: null,
                titulo: null,
                conteudo: null,
                dataAbertura: null
            };
        }

        async function abrirPlanoEdicao(planoId) {
            try {
                console.log('🚀 INICIANDO abrirPlanoEdicao com ID:', planoId, 'tipo:', typeof planoId);
                showInfo('Carregando...', 'Abrindo plano para edição');
                
                // GARANTIA CRÍTICA - Validar planoId antes de prosseguir
                if (!planoId || planoId === null || planoId === undefined || isNaN(parseInt(planoId))) {
                    throw new Error(`ID do plano inválido: ${planoId}`);
                }
                
                const response = await fetch(`/api/planos-aula/${planoId}`);
                console.log('📡 Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('📦 Data recebida:', data);
                
                if (data.plano || data.success) {
                    const plano = data.plano || data;
                    
                    // SUPER CRITICAL FIX - Múltiplas formas de armazenar o ID
                    const planoIdNumerico = parseInt(planoId);
                    
                    // 1. Window global
                    window.planoAtualId = planoIdNumerico;
                    window.planoAtualTitulo = plano.titulo || 'Plano de Aula';
                    
                    // 2. Variáveis locais  
                    window.planoAtualIdLocal = planoIdNumerico;
                    window.planoAtualTituloLocal = plano.titulo || 'Plano de Aula';
                    
                    // 3. SessionStorage como backup
                    sessionStorage.setItem('planoAtualId', planoIdNumerico.toString());
                    sessionStorage.setItem('planoAtualTitulo', plano.titulo || 'Plano de Aula');
                    
                    // 4. Atributo data no modal como último recurso
                    const modal = document.getElementById('modal-editor-plano');
                    if (modal) {
                        modal.setAttribute('data-plano-id', planoIdNumerico.toString());
                        modal.setAttribute('data-plano-titulo', plano.titulo || 'Plano de Aula');
                    }
                    
                    console.log('✅ VARIÁVEIS DEFINIDAS COM MÚLTIPLOS BACKUPS:', {
                        'window.planoAtualId': window.planoAtualId,
                        'window.planoAtualIdLocal': window.planoAtualIdLocal,
                        'sessionStorage': sessionStorage.getItem('planoAtualId'),
                        'modal_data_id': modal ? modal.getAttribute('data-plano-id') : 'N/A',
                        'tipo_window_id': typeof window.planoAtualId,
                        'planoId_original': planoId,
                        'planoIdNumerico': planoIdNumerico
                    });
                    
                    // Carregar conteúdo no editor
                    const editorConteudo = document.getElementById('editor-conteudo');
                    if (!editorConteudo) {
                        throw new Error('Editor de conteúdo não encontrado!');
                    }
                    
                    const conteudoPlano = plano.conteudo || '<h1>Plano de Aula</h1><p>Conteúdo do plano...</p>';
                    console.log('📝 Conteúdo do plano (primeiros 100 chars):', conteudoPlano.substring(0, 100));
                    
                    // Melhor formatação do conteúdo para edição
                    editorConteudo.innerHTML = formatarConteudoParaEdicao(conteudoPlano);
                    
                    // Atualizar título do modal
                    const modalTitulo = document.querySelector('#modal-editor-plano .modal-header h2');
                    if (modalTitulo) {
                        modalTitulo.innerHTML = `<i class="fas fa-edit"></i> Editando: ${window.planoAtualTitulo}`;
                    }
                    
                    // Mostrar modal (reutilizar variável modal já definida acima)
                    if (!modal) {
                        throw new Error('Modal do editor não encontrado!');
                    }
                    modal.style.display = 'flex';
                    
                    // Focar no editor após um pequeno delay
                    setTimeout(() => {
                        editorConteudo.focus();
                        console.log('🎯 Editor focado');
                    }, 300);
                    
                    showSuccess('Plano Carregado', `Editando: ${window.planoAtualTitulo}`);
                    
                    // TESTE FINAL - Verificar se as variáveis ainda estão definidas
                    setTimeout(() => {
                        console.log('🔍 VERIFICAÇÃO FINAL após 1 segundo:', {
                            'window.planoAtualId': window.planoAtualId,
                            'planoAtualId': typeof planoAtualId !== 'undefined' ? planoAtualId : 'UNDEFINED',
                            'modal_visivel': document.getElementById('modal-editor-plano').style.display === 'flex'
                        });
                    }, 1000);
                    
                } else {
                    console.error('❌ Dados do plano não encontrados:', data);
                    showError('Erro', 'Não foi possível carregar o plano - dados inválidos');
                }
            } catch (error) {
                console.error('💥 ERRO FATAL ao carregar plano:', error);
                showError('Erro', `Erro ao carregar plano: ${error.message}`);
            }
        }

        function formatarConteudoParaEdicao(conteudo) {
            // Melhor formatação do conteúdo para o editor
            if (!conteudo || conteudo.trim() === '') {
                return '<h1>Plano de Aula</h1><p>Adicione o conteúdo do seu plano aqui...</p>';
            }
            
            // Se for texto puro (markdown), converter para HTML
            if (!conteudo.includes('<')) {
                return formatarPlanoTexto(conteudo);
            }
            
            // Se já for HTML, retornar como está
            return conteudo;
        }

        function fecharModalEditor() {
            console.log('🚪 FECHANDO modal do editor');
            
            const modal = document.getElementById('modal-editor-plano');
            if (modal) {
                modal.style.display = 'none';
            }
            
            // Limpar TODOS OS BACKUPS - CRITICAL FIX
            // 1. Window global
            window.planoAtualId = null;
            window.planoAtualTitulo = null;
            
            // 2. Window local
            window.planoAtualIdLocal = null;
            window.planoAtualTituloLocal = null;
            
            // 3. SessionStorage
            sessionStorage.removeItem('planoAtualId');
            sessionStorage.removeItem('planoAtualTitulo');
            
            // 4. Atributos data do modal
            if (modal) {
                modal.removeAttribute('data-plano-id');
                modal.removeAttribute('data-plano-titulo');
            }
            
            // Limpar conteúdo do editor também
            const editorConteudo = document.getElementById('editor-conteudo');
            if (editorConteudo) {
                editorConteudo.innerHTML = '';
            }
            
            console.log('✅ Modal fechado e TODOS os backups limpos:', {
                'window.planoAtualId': window.planoAtualId,
                'window.planoAtualIdLocal': window.planoAtualIdLocal,
                'sessionStorage': sessionStorage.getItem('planoAtualId'),
                'modal_data_id': modal ? modal.getAttribute('data-plano-id') : 'N/A',
                'modal_display': modal ? modal.style.display : 'N/A'
            });
        }

        function formatarTexto(comando) {
            document.execCommand(comando, false, null);
            document.getElementById('editor-conteudo').focus();
        }

        async function salvarPlanoEditado() {
            console.log('💾 INICIANDO salvarPlanoEditado');
            
            // SISTEMA DE MÚLTIPLOS BACKUPS - Tentar recuperar ID de qualquer fonte
            let idParaSalvar = null;
            let tituloParaSalvar = null;
            
            // 1. Tentar window.planoAtualId
            if (window.planoAtualId && !isNaN(window.planoAtualId)) {
                idParaSalvar = window.planoAtualId;
                tituloParaSalvar = window.planoAtualTitulo;
                console.log('✅ ID recuperado de window.planoAtualId:', idParaSalvar);
            }
            // 2. Tentar window.planoAtualIdLocal
            else if (window.planoAtualIdLocal && !isNaN(window.planoAtualIdLocal)) {
                idParaSalvar = window.planoAtualIdLocal;
                tituloParaSalvar = window.planoAtualTituloLocal;
                console.log('✅ ID recuperado de window.planoAtualIdLocal:', idParaSalvar);
            }
            // 3. Tentar sessionStorage
            else if (sessionStorage.getItem('planoAtualId')) {
                idParaSalvar = parseInt(sessionStorage.getItem('planoAtualId'));
                tituloParaSalvar = sessionStorage.getItem('planoAtualTitulo');
                console.log('✅ ID recuperado de sessionStorage:', idParaSalvar);
            }
            // 4. Tentar atributo data do modal
            else {
                const modal = document.getElementById('modal-editor-plano');
                if (modal && modal.getAttribute('data-plano-id')) {
                    idParaSalvar = parseInt(modal.getAttribute('data-plano-id'));
                    tituloParaSalvar = modal.getAttribute('data-plano-titulo');
                    console.log('✅ ID recuperado de data-plano-id:', idParaSalvar);
                }
            }
            
            console.log('🔍 VERIFICAÇÃO FINAL DE TODAS AS FONTES:', {
                'window.planoAtualId': window.planoAtualId,
                'window.planoAtualIdLocal': window.planoAtualIdLocal,
                'sessionStorage': sessionStorage.getItem('planoAtualId'),
                'modal_data_id': document.getElementById('modal-editor-plano')?.getAttribute('data-plano-id'),
                'idParaSalvar_final': idParaSalvar,
                'tituloParaSalvar_final': tituloParaSalvar,
                'modal_aberto': document.getElementById('modal-editor-plano')?.style.display === 'flex'
            });
            
            // Verificação mais robusta - CRITICAL FIX
            if (!idParaSalvar || idParaSalvar === null || idParaSalvar === undefined || isNaN(idParaSalvar)) {
                console.error('🚨 ERRO CRÍTICO - Nenhum ID válido encontrado em NENHUMA fonte:', {
                    'tentativas': {
                        'window.planoAtualId': window.planoAtualId,
                        'window.planoAtualIdLocal': window.planoAtualIdLocal,
                        'sessionStorage': sessionStorage.getItem('planoAtualId'),
                        'modal_data_id': document.getElementById('modal-editor-plano')?.getAttribute('data-plano-id')
                    },
                    'idParaSalvar_final': idParaSalvar,
                    'isNaN_check': isNaN(idParaSalvar)
                });
                
                showError('Erro Crítico', 'ID do plano perdido! Feche o modal e tente abrir o plano novamente.');
                
                // Forçar fechamento e limpeza
                setTimeout(() => {
                    fecharModalEditor();
                }, 2000);
                return;
            }

            console.log('✅ ID VÁLIDO ENCONTRADO - Prosseguindo com salvamento:', {
                id: idParaSalvar,
                titulo: tituloParaSalvar,
                tipo_id: typeof idParaSalvar
            });

            const editorConteudo = document.getElementById('editor-conteudo');
            if (!editorConteudo) {
                showError('Erro', 'Editor de conteúdo não encontrado');
                return;
            }
            
            const conteudo = editorConteudo.innerHTML;
            
            if (!conteudo || conteudo.trim() === '' || conteudo.trim() === '<br>' || conteudo.trim() === '<p></p>') {
                showError('Erro', 'O conteúdo do plano não pode estar vazio');
                return;
            }
            
            try {
                showInfo('Salvando...', `Salvando plano ID ${idParaSalvar}...`);
                console.log('📡 ENVIANDO REQUEST PUT para:', `/api/planos-aula/${idParaSalvar}`);
                
                const requestBody = { 
                    conteudo: conteudo,
                    titulo: tituloParaSalvar || 'Plano de Aula'
                };
                
                console.log('📦 BODY DA REQUEST:', requestBody);
                
                const response = await fetch(`/api/planos-aula/${idParaSalvar}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('📡 RESPOSTA HTTP Status:', response.status);
                console.log('📡 RESPOSTA HTTP StatusText:', response.statusText);

                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ SUCESSO - Dados da resposta:', data);
                    
                    showSuccess('Sucesso!', `Plano "${tituloParaSalvar}" salvo com sucesso!`);
                    
                    // Fechar modal após salvar
                    setTimeout(() => {
                        console.log('🚪 Fechando modal após salvamento bem-sucedido');
                        fecharModalEditor();
                        // Recarregar lista de planos para mostrar alterações
                        if (typeof carregarPlanosSalvos === 'function') {
                            carregarPlanosSalvos();
                        }
                    }, 1500);
                    
                } else {
                    const responseText = await response.text();
                    console.error('❌ ERRO HTTP - Status:', response.status, 'Response:', responseText);
                    
                    let errorData;
                    try {
                        errorData = JSON.parse(responseText);
                    } catch (e) {
                        errorData = { error: `Erro HTTP ${response.status}: ${responseText}` };
                    }
                    
                    showError('Erro do Servidor', errorData.error || `Erro HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('💥 ERRO FATAL durante salvamento:', error);
                showError('Erro de Conexão', `Falha na comunicação: ${error.message}`);
            }
        }

        function baixarPlanoEditado() {
            const conteudo = document.getElementById('editor-conteudo').innerHTML;
            const titulo = `Plano_de_Aula_${new Date().toISOString().split('T')[0]}`;
            
            // Criar um documento HTML temporário para impressão
            const janela = window.open('', '_blank');
            janela.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${titulo}</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            line-height: 1.6; 
                            margin: 40px; 
                            color: #333; 
                        }
                        h1 { 
                            color: #457D97; 
                            border-bottom: 2px solid #457D97; 
                            padding-bottom: 10px; 
                        }
                        h2, h3 { 
                            color: #457D97; 
                            margin-top: 25px; 
                        }
                        p { 
                            margin-bottom: 15px; 
                        }
                        ul, ol { 
                            margin: 15px 0; 
                            padding-left: 30px; 
                        }
                        @media print {
                            body { margin: 20px; }
                        }
                    </style>
                </head>
                <body>
                    ${conteudo}
                </body>
                </html>
            `);
            janela.document.close();
            janela.focus();
            janela.print();
            
            showSuccess('Download Iniciado', 'Use Ctrl+P para salvar como PDF');
        }

        async function baixarPlanoPDF(planoId) {
            try {
                const response = await fetch(`/api/planos-aula/${planoId}`);
                const data = await response.json();
                
                if (data.plano) {
                    const titulo = `Plano_de_Aula_${new Date().toISOString().split('T')[0]}`;
                    
                    // Criar janela para impressão
                    const janela = window.open('', '_blank');
                    janela.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>${titulo}</title>
                            <style>
                                body { 
                                    font-family: Arial, sans-serif; 
                                    line-height: 1.6; 
                                    margin: 40px; 
                                    color: #333; 
                                }
                                h1 { 
                                    color: #457D97; 
                                    border-bottom: 2px solid #457D97; 
                                    padding-bottom: 10px; 
                                }
                                h2, h3 { 
                                    color: #457D97; 
                                    margin-top: 25px; 
                                }
                                p { 
                                    margin-bottom: 15px; 
                                }
                                ul, ol { 
                                    margin: 15px 0; 
                                    padding-left: 30px; 
                                }
                                @media print {
                                    body { margin: 20px; }
                                }
                            </style>
                        </head>
                        <body>
                            ${data.plano.conteudo}
                        </body>
                        </html>
                    `);
                    janela.document.close();
                    janela.focus();
                    janela.print();
                    
                    showSuccess('Download Iniciado', 'Use Ctrl+P para salvar como PDF');
                } else {
                    showError('Erro', 'Não foi possível carregar o plano');
                }
            } catch (error) {
                console.error('Erro ao baixar plano:', error);
                showError('Erro', 'Erro ao preparar download do plano');
            }
        }

        // Fechar modal clicando fora dele
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                fecharModalEditor();
            }
        });

        // Fechar modal com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('modal-editor-plano').style.display === 'flex') {
                fecharModalEditor();
            }
        });

        // Funções auxiliares para formatação e ações - MELHORADA
        function formatarPlanoTexto(texto) {
            if (!texto) return '<p>Erro: Conteúdo do plano não encontrado</p>';
            
            // Limpar texto e normalizar quebras de linha
            let html = texto
                .replace(/\r\n/g, '\n')
                .replace(/\r/g, '\n')
                .trim();
            
            // Detectar e marcar seções especiais
            html = html
                // Marcar títulos principais (###)
                .replace(/^### (.*$)/gim, '<h1>$1</h1>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h3>$1</h3>')
                
                // Detectar blocos importantes
                .replace(/\*\*IMPORTANTE:\*\*(.*?)(?=\n\n|\n###|\n##|\n#|$)/gs, '<div class="destaque">$1</div>')
                .replace(/\*\*ATENÇÃO:\*\*(.*?)(?=\n\n|\n###|\n##|\n#|$)/gs, '<div class="destaque">$1</div>')
                .replace(/\*\*NOTA:\*\*(.*?)(?=\n\n|\n###|\n##|\n#|$)/gs, '<div class="destaque">$1</div>')
                
                // Formatação de texto
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                
                // Detectar listas com diferentes marcadores
                .replace(/^[\-\*\+] (.+)$/gm, '<li>$1</li>')
                .replace(/^\d+\. (.+)$/gm, '<oli>$1</oli>')
                
                // Separadores visuais
                .replace(/^[-=]{3,}$/gm, '<hr>')
                
                // Converter quebras duplas em parágrafos
                .replace(/\n\n+/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // Agrupar listas consecutivas
            html = html
                .replace(/(<li>.*?<\/li>)+/gs, function(match) {
                    return '<ul>' + match + '</ul>';
                })
                .replace(/(<oli>.*?<\/oli>)+/gs, function(match) {
                    return '<ol>' + match.replace(/oli>/g, 'li>') + '</ol>';
                });
            
            // Envolver em parágrafos se necessário
            if (!html.startsWith('<h') && !html.startsWith('<p>') && !html.startsWith('<div')) {
                html = '<p>' + html + '</p>';
            }
            
            // Limpeza final
            html = html
                .replace(/<p><\/p>/g, '')
                .replace(/<p><br><\/p>/g, '')
                .replace(/<br><\/p>/g, '</p>')
                .replace(/<p><br>/g, '<p>')
                .replace(/(<\/h[1-6]>)<br>/g, '$1')
                .replace(/(<\/li>)<br>/g, '$1')
                .replace(/(<\/ul>)<br>/g, '$1')
                .replace(/(<\/ol>)<br>/g, '$1')
                .replace(/(<\/div>)<br>/g, '$1');
            
            return html;
        }
        
        function configurarBotoesAcao(planoTexto, dadosFormulario) {
            // Remover listeners anteriores
            const btnDownload = document.getElementById('btn-download');
            const btnSalvar = document.getElementById('btn-salvar');
            
            if (btnDownload) {
                btnDownload.onclick = function() {
                    baixarPlanoPDF(planoTexto, dadosFormulario);
                };
            }
            
            if (btnSalvar) {
                btnSalvar.onclick = function() {
                    salvarPlanoNoBanco(planoTexto, dadosFormulario);
                };
            }
        }
        
        function baixarPlanoPDF(planoTexto, dados) {
            try {
                const titulo = `Plano_de_Aula_${dados.componente}_${dados.ano}ano_${new Date().toISOString().split('T')[0]}`;
                
                // Criar janela para impressão
                const janela = window.open('', '_blank');
                janela.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${titulo}</title>
                        <meta charset="UTF-8">
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                line-height: 1.6; 
                                margin: 40px; 
                                color: #333; 
                            }
                            h1 { 
                                color: #457D97; 
                                border-bottom: 2px solid #457D97; 
                                padding-bottom: 10px; 
                                font-size: 1.8rem;
                            }
                            h2, h3 { 
                                color: #457D97; 
                                margin-top: 25px; 
                            }
                            p { 
                                margin-bottom: 15px; 
                                text-align: justify;
                            }
                            ul, ol { 
                                margin: 15px 0; 
                                padding-left: 30px; 
                            }
                            li {
                                margin-bottom: 5px;
                            }
                            strong {
                                color: #2c3e50;
                            }
                            @media print {
                                body { margin: 20px; }
                                h1 { font-size: 1.5rem; }
                            }
                        </style>
                    </head>
                    <body>
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h1>📚 PLANO DE AULA</h1>
                            <p><strong>Componente:</strong> ${dados.componente} | <strong>Ano:</strong> ${dados.ano}º ano</p>
                            <p><strong>Tema:</strong> ${dados.tema}</p>
                            <hr style="border: 1px solid #457D97; margin: 20px 0;">
                        </div>
                        ${formatarPlanoTexto(planoTexto)}
                        <hr style="border: 1px solid #457D97; margin: 20px 0;">
                        <p style="text-align: center; font-size: 0.9rem; color: #666;">
                            Plano gerado pela EduPlataforma - ${new Date().toLocaleDateString('pt-BR')}
                        </p>
                    </body>
                    </html>
                `);
                janela.document.close();
                janela.focus();
                janela.print();
                
                showSuccess('Download Iniciado', 'Use Ctrl+P para salvar como PDF');
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                showError('Erro', 'Falha ao gerar PDF para download');
            }
        }
        
        async function salvarPlanoNoBanco(planoTexto, dados) {
            try {
                const titulo = `${dados.tema} - ${dados.componente} ${dados.ano}º ano`;
                
                const dadosPlano = {
                    titulo: titulo,
                    conteudo: planoTexto,
                    componente: dados.componente,
                    ano: dados.ano
                };
                
                const response = await fetch('/api/planos-aula', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dadosPlano)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showSuccess('Sucesso!', 'Plano salvo com sucesso no histórico');
                    
                    // Recarregar a página após salvar para garantir layout consistente
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500); // Aguardar 1.5 segundos para mostrar a mensagem de sucesso
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Erro ao salvar plano');
                }
                
            } catch (error) {
                console.error('Erro ao salvar plano:', error);
                showError('Erro', `Falha ao salvar plano: ${error.message}`);
            }
        }
        
        // Função removida - agora recarregamos a página após salvar

        // Função para atualizar card existente sem recarregar
        function atualizarCardExistente(planoId, novoConteudo) {
            const grid = document.getElementById('planos-grid');
            const cards = grid.querySelectorAll('.plano-card');
            
            cards.forEach(card => {
                const btnVisualizar = card.querySelector('.btn-visualizar');
                if (btnVisualizar && btnVisualizar.onclick && btnVisualizar.onclick.toString().includes(planoId)) {
                    // Encontrou o card correto, atualizar preview
                    const previewElement = card.querySelector('.plano-preview');
                    if (previewElement && novoConteudo) {
                        // Limpar e formatar novo preview
                        let textoLimpo = novoConteudo
                            .replace(/<[^>]*>/g, '')
                            .replace(/[#*\-\n]/g, ' ')
                            .replace(/\s+/g, ' ')
                            .trim();
                        
                        let novoPreview = 'Plano atualizado';
                        if (textoLimpo.length > 150) {
                            novoPreview = textoLimpo.substring(0, 150) + '...';
                        } else if (textoLimpo.length > 0) {
                            novoPreview = textoLimpo;
                        }
                        
                        // Atualizar preview sem animação
                        previewElement.textContent = novoPreview;
                    }
                    
                    // Remover alterações visuais para manter aparência padrão
                }
            });
        }

        // Função para atualizar estatísticas
        function atualizarEstatisticas(totalPlanos) {
            // Atualizar contador de planos salvos
            const totalPlanosElement = document.getElementById('total-planos');
            if (totalPlanosElement) {
                animarContador('total-planos', totalPlanos);
            }
            
            // Atualizar planos de hoje (simulado - seria necessário API para dados reais)
            const planosHojeElement = document.getElementById('planos-hoje');
            if (planosHojeElement) {
                // Para simplificar, mostrar 1 se houver planos
                animarContador('planos-hoje', totalPlanos > 0 ? 1 : 0);
            }
        }

        // Substituir alerts existentes por toasts
        const originalAlert = window.alert;
        window.alert = function(message) {
            showInfo('Informação', message);
        };

        const originalConfirm = window.confirm;
        window.confirm = function(message) {
            // Para confirms, manter o comportamento original por enquanto
            // Pode ser substituído por modais customizados no futuro
            return originalConfirm(message);
        };
    </script>
{% endblock %}