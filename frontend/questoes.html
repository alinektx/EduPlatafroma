{% extends "base.html" %}

{% block title %}Gestão de Questões{% endblock %}

{% block content %}
    <div class="questoes-container">
        <!-- Sistema de Notificações Toast -->
        <div id="toast-container" class="toast-container"></div>
        
        <!-- Header da página -->
        <header class="page-header">
            <div class="header-content">
                <h1><i class="fas fa-question-circle"></i> Gestão de Questões</h1>
                <p>Sistema inteligente para criar e gerenciar questões educacionais</p>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <span class="stat-number" id="total-questoes">0</span>
                    <span class="stat-label">Total</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="matematica-count">0</span>
                    <span class="stat-label">Matemática</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="portugues-count">0</span>
                    <span class="stat-label">Português</span>
                </div>
            </div>
        </header>

        <!-- Cards de ações -->
        <section class="actions-section">
            <div class="actions-grid">
                <!-- Card de Importação -->
                <div class="action-card import-card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-file-excel"></i>
                        </div>
                        <div class="card-title">
                            <h2>Importar Questões</h2>
                            <p>Upload de arquivo Excel com múltiplas questões</p>
                        </div>
                    </div>
                    <div class="card-content">
                        <form id="form-importar-excel" enctype="multipart/form-data">
                            <div class="file-upload-area">
                                <input type="file" id="arquivo-excel" name="arquivo" accept=".xlsx" required>
                                <label for="arquivo-excel" class="file-upload-label">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <span>Selecionar arquivo Excel</span>
                                </label>
                            </div>
                            <div class="upload-actions">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-upload"></i>
                                    Importar
                                </button>
                                <a href="/static/modelo_questoes.xlsx" class="btn btn-secondary" download>
                                    <i class="fas fa-download"></i>
                                    Baixar Modelo
                                </a>
                            </div>
                            <div id="import-feedback" class="feedback-message"></div>
                        </form>
                    </div>
                </div>

                <!-- Card de Cadastro -->
                <div class="action-card form-card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-plus-circle"></i>
                        </div>
                        <div class="card-title">
                            <h2>Nova Questão</h2>
                            <p>Cadastre manualmente uma nova questão</p>
                        </div>
                        <button id="btn-buscar-habilidades" class="btn btn-outline">
                            <i class="fas fa-search"></i>
                            Buscar Habilidades
                        </button>
                    </div>
                    <div class="card-content">
                        <form id="questao-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="ano">Ano Escolar *</label>
                                    <select id="ano" name="ano" required>
                                        <option value="">Selecione o ano...</option>
                                        <option value="1">1º ano</option>
                                        <option value="2">2º ano</option>
                                        <option value="3">3º ano</option>
                                        <option value="4">4º ano</option>
                                        <option value="5">5º ano</option>
                                        <option value="6">6º ano</option>
                                        <option value="7">7º ano</option>
                                        <option value="8">8º ano</option>
                                        <option value="9">9º ano</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="habilidade">Habilidade BNCC *</label>
                                    <select id="habilidade" name="habilidade_id" required>
                                        <option value="">Selecione...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="componente">Componente Curricular *</label>
                                    <select id="componente" name="componente" required>
                                        <option value="">Selecione...</option>
                                        <option value="Matemática">Matemática</option>
                                        <option value="Língua Portuguesa">Língua Portuguesa</option>
                                        <option value="História">História</option>
                                        <option value="Geografia">Geografia</option>
                                        <option value="Ciências">Ciências</option>
                                        <option value="Arte">Arte</option>
                                        <option value="Educação Física">Educação Física</option>
                                        <option value="Ensino Religioso">Ensino Religioso</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="dificuldade">Dificuldade *</label>
                                    <select id="dificuldade" name="dificuldade" required>
                                        <option value="">Selecione...</option>
                                        <option value="Fácil">Fácil</option>
                                        <option value="Médio">Médio</option>
                                        <option value="Difícil">Difícil</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="enunciado">Enunciado da Questão *</label>
                                <textarea id="enunciado" name="enunciado" rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="imagem">Imagem da Questão (opcional)</label>
                                <div class="image-upload-area">
                                    <input type="file" id="imagem" name="imagem" accept="image/*">
                                    <label for="imagem" class="image-upload-label">
                                        <i class="fas fa-image"></i>
                                        <span>Selecionar imagem</span>
                                        <small>PNG, JPG, JPEG até 5MB</small>
                                    </label>
                                    <div class="image-preview" id="image-preview" style="display: none;">
                                        <img id="preview-img" src="" alt="Preview">
                                        <button type="button" class="remove-image" onclick="removerImagem()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="alternativa_a">Alternativa A *</label>
                                <input type="text" id="alternativa_a" name="alternativa_a" required>
                            </div>
                            <div class="form-group">
                                <label for="alternativa_b">Alternativa B *</label>
                                <input type="text" id="alternativa_b" name="alternativa_b" required>
                            </div>
                            <div class="form-group">
                                <label for="alternativa_c">Alternativa C *</label>
                                <input type="text" id="alternativa_c" name="alternativa_c" required>
                            </div>
                            <div class="form-group">
                                <label for="alternativa_d">Alternativa D *</label>
                                <input type="text" id="alternativa_d" name="alternativa_d" required>
                            </div>
                            <div class="form-group">
                                <label for="resposta_correta">Resposta Correta *</label>
                                <select id="resposta_correta" name="resposta_correta" required>
                                    <option value="">Selecione...</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                            <div class="form-buttons">
                                <button type="submit" class="btn btn-primary btn-block">
                                    <i class="fas fa-save"></i>
                                    Salvar Questão
                                </button>
                                <button type="button" id="btn-cancelar-edicao" class="btn btn-secondary btn-block" style="display: none;" onclick="cancelarEdicao()">
                                    <i class="fas fa-times"></i>
                                    Cancelar Edição
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- Lista de Questões -->
        <section class="list-section">
            <div class="list-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-list"></i>
                    </div>
                    <div class="card-title">
                        <h2>Questões Cadastradas</h2>
                        <p>Visualize e gerencie todas as questões</p>
                    </div>
                    <div class="search-box">
                        <input type="text" id="search-questoes" placeholder="Buscar questão...">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
                <div class="card-content">
                    <div class="questoes-grid" id="questoes-grid">
                        <!-- Questões serão carregadas aqui dinamicamente -->
                    </div>

                    <div class="empty-state" id="empty-state" style="display: none;">
                        <div class="empty-icon">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <h3>Nenhuma questão cadastrada</h3>
                        <p>Comece cadastrando uma nova questão ou importe um arquivo Excel</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Botão Voltar -->
        <div class="back-section">
            <a href="/dashboard" class="btn btn-back">
                <i class="fas fa-arrow-left"></i>
                Voltar ao Dashboard
            </a>
        </div>
    </div>

    <!-- Modal de Visualização de Imagem -->
    <div id="imagemModal" class="imagem-modal" style="display: none;" onclick="fecharImagemModal()">
        <div class="imagem-modal-content">
            <img id="imagemModalImg" src="" alt="Imagem da questão">
            <button class="imagem-modal-close" onclick="fecharImagemModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
</div>

    </div>

    <style>
        /* Questões Styles - Seguindo padrão do Dashboard */
        .questoes-container {
            padding: 0;
            max-width: 100%;
        }

        .page-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 2rem 1.5rem;
            margin: -1.5rem -1.5rem 2rem -1.5rem;
            border-radius: 0 0 20px 20px;
        }

        .header-content {
            text-align: center;
            margin-bottom: 2rem;
        }

        .page-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0 0 0.5rem 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .page-header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
        }

        .header-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1rem 1.5rem;
            min-width: 120px;
        }

        .stat-number {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Actions Section */
        .actions-section {
            margin-bottom: 2rem;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .action-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .action-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
        }

        .card-header {
            background: var(--gray-light);
            padding: 1.5rem;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            background: var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .card-title {
            flex: 1;
        }

        .card-title h2 {
            font-size: 1.3rem;
            color: var(--primary-dark);
            margin: 0 0 0.25rem 0;
        }

        .card-title p {
            color: #666;
            margin: 0;
            font-size: 0.9rem;
        }

        .card-content {
            padding: 1.5rem;
        }

        /* File Upload */
        .file-upload-area {
            margin-bottom: 1rem;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--gray-light);
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--primary-dark);
            font-weight: 500;
        }

        .file-upload-label:hover {
            border-color: var(--primary);
            background: #f8f9fa;
        }

        .file-upload-label i {
            font-size: 1.5rem;
            color: var(--primary);
        }

        #arquivo-excel {
            display: none;
        }

        /* Image Upload */
        .image-upload-area {
            margin-bottom: 1rem;
        }

        .image-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            background: var(--gray-light);
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--primary-dark);
            font-weight: 500;
            text-align: center;
        }

        .image-upload-label:hover {
            border-color: var(--primary);
            background: #f8f9fa;
        }

        .image-upload-label i {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .image-upload-label small {
            color: #666;
            font-size: 0.85rem;
        }

        #imagem {
            display: none;
        }

        .image-preview {
            position: relative;
            margin-top: 1rem;
            border-radius: 10px;
            overflow: hidden;
            background: #f8f9fa;
            border: 2px solid #e1e8ed;
        }

        .image-preview img {
            width: 100%;
            height: auto;
            max-height: 200px;
            object-fit: contain;
            display: block;
        }

        .remove-image {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(234, 67, 53, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .remove-image:hover {
            background: #ea4335;
            transform: scale(1.1);
        }

        .upload-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* Form Styles */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.75rem;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group textarea {
            resize: vertical;
            font-family: inherit;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            text-align: center;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-back {
            background: var(--gray-light);
            color: var(--primary-dark);
            border: 1px solid #e1e8ed;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-block {
            width: 100%;
        }

        /* Form buttons */
        .form-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        /* Sistema de Notificações Toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success { border-left-color: #28a745; }
        .toast.error { border-left-color: #dc3545; }
        .toast.warning { border-left-color: #ffc107; }
        .toast.info { border-left-color: #17a2b8; }

        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            flex-shrink: 0;
        }

        .toast.success .toast-icon { background: #28a745; }
        .toast.error .toast-icon { background: #dc3545; }
        .toast.warning .toast-icon { background: #ffc107; }
        .toast.info .toast-icon { background: #17a2b8; }

        .toast-content { flex: 1; }
        .toast-title {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            margin-bottom: 2px;
        }
        .toast-message {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        /* Search Box */
        .search-box {
            position: relative;
            margin-left: auto;
        }

        .search-box input {
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            width: 250px;
            font-size: 1rem;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-box i {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        /* List Section */
        .list-section {
            max-width: 1200px;
            margin: 0 auto;
        }

        .list-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        /* Questões Grid */
        .questoes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .questao-card {
            background: white;
            border-radius: 15px;
            border: 2px solid #e1e8ed;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .questao-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .questao-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .questao-codigo {
            flex: 1;
        }

        .codigo-badge {
            background: linear-gradient(135deg, var(--primary), #457d97);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }

        .questao-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .edit-btn {
            background: rgba(52, 168, 83, 0.1);
            color: #34a853;
            border: 1px solid rgba(52, 168, 83, 0.2);
        }

        .delete-btn {
            background: rgba(234, 67, 53, 0.1);
            color: #ea4335;
            border: 1px solid rgba(234, 67, 53, 0.2);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .edit-btn:hover {
            background: #34a853;
            color: white;
            border-color: #34a853;
        }

        .delete-btn:hover {
            background: #ea4335;
            color: white;
            border-color: #ea4335;
        }

        .questao-info {
            space-y: 1rem;
        }

        .questao-meta {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #666;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .meta-item i {
            color: var(--primary);
            width: 16px;
        }

        .questao-enunciado {
            color: #333;
            line-height: 1.6;
            font-size: 0.95rem;
            text-align: justify;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }

        /* Questão com imagem */
        .questao-imagem {
            position: relative;
            margin: 1rem 0;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .questao-imagem:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .questao-imagem img {
            width: 100%;
            height: auto;
            max-height: 150px;
            object-fit: cover;
            display: block;
            border-radius: 10px;
        }

        .imagem-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 10px;
        }

        .questao-imagem:hover .imagem-overlay {
            opacity: 1;
        }

        .imagem-overlay i {
            color: white;
            font-size: 1.5rem;
        }

        /* Modal de Imagem */
        .imagem-modal {
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .imagem-modal.show {
            opacity: 1;
        }

        .imagem-modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .imagem-modal-content img {
            width: 100%;
            height: auto;
            max-width: 800px;
            max-height: 600px;
            object-fit: contain;
            display: block;
        }

        .imagem-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            color: #333;
            transition: all 0.3s ease;
        }

        .imagem-modal-close:hover {
            background: white;
            transform: scale(1.1);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .empty-icon {
            width: 80px;
            height: 80px;
            background: var(--gray-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: var(--primary);
            font-size: 2rem;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin: 0 0 0.5rem 0;
            color: var(--primary-dark);
        }

        /* Back Section */
        .back-section {
            text-align: center;
            margin-top: 2rem;
        }

        /* Feedback Message */
        .feedback-message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 6px;
            font-weight: 500;
        }

        .feedback-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feedback-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .feedback-message.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .page-header {
                padding: 1.5rem 1rem;
                margin: -1rem -1rem 1.5rem -1rem;
            }

            .page-header h1 {
                font-size: 2rem;
                flex-direction: column;
                gap: 0.5rem;
            }

            .header-stats {
                flex-direction: column;
                gap: 1rem;
            }

            .actions-grid {
                grid-template-columns: 1fr;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .search-box {
                margin-left: 0;
                width: 100%;
            }

            .search-box input {
                width: 100%;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .upload-actions {
                flex-direction: column;
            }

            .questoes-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .questao-card {
                padding: 1rem;
            }

            .questao-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .questao-actions {
                align-self: flex-end;
            }

            .questao-meta {
                gap: 1rem;
            }
        }

        @media (max-width: 480px) {
            .stat-item {
                padding: 0.75rem 1rem;
                min-width: 100px;
            }

            .stat-number {
                font-size: 1.5rem;
            }

            .questoes-grid {
                grid-template-columns: 1fr;
            }

            .codigo-badge {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }

            .action-btn {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }

            .meta-item {
                font-size: 0.8rem;
            }

            .questao-enunciado {
                font-size: 0.9rem;
                padding: 0.8rem;
            }
        }

    </style>

    <script>
        // Sistema de Notificações Toast
        function showToast(type, title, message) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '✓',
                error: '✕',
                warning: '⚠',
                info: 'ℹ'
            };

            toast.innerHTML = `
                <div class="toast-icon">
                    ${icons[type] || 'ℹ'}
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="closeToast(this)">×</button>
                <div class="toast-progress"></div>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            setTimeout(() => {
                closeToast(toast);
            }, 4000);
        }

        function closeToast(element) {
            const toast = element.classList ? element : element.closest('.toast');
            if (toast) {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }
        }

        function showSuccess(title, message = '') {
            showToast('success', title, message);
        }

        function showError(title, message = '') {
            showToast('error', title, message);
        }

        function showWarning(title, message = '') {
            showToast('warning', title, message);
        }

        function showInfo(title, message = '') {
            showToast('info', title, message);
        }

        // Inicialização da página
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando página de questões...');
            
            carregarQuestoes();
            carregarEstatisticas();
            configurarBusca();
            configurarFormulario();
            configurarImportacao();
            carregarHabilidades();
            configurarUploadImagem();
        });

        // Função para carregar questões
        async function carregarQuestoes() {
            try {
                console.log('Buscando questões via API...');
                const response = await fetch('/api/questoes');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.questoes && data.questoes.length > 0) {
                    console.log(`API retornou ${data.questoes.length} questões`);
                    preencherCards(data.questoes);
                } else {
                    console.log('API não retornou questões');
                    mostrarEmptyState();
                }
            } catch (error) {
                console.error('Erro ao buscar questões via API:', error);
                mostrarEmptyState();
            }
        }

        // Função para mostrar estado vazio
        function mostrarEmptyState() {
            const emptyState = document.querySelector('#empty-state');
            if (emptyState) {
                emptyState.style.display = 'block';
            }
        }

        // Função para preencher os cards dinamicamente
        function preencherCards(questoes) {
            const grid = document.querySelector('#questoes-grid');
            const emptyState = document.querySelector('#empty-state');
            
            if (!grid) {
                console.error('Não foi possível encontrar o grid');
                return;
            }
            
            // Limpar grid
            grid.innerHTML = '';
            
            // Buscar habilidades para mapear
            fetch('/api/habilidades')
                .then(r => r.json())
                .then(habilidadesData => {
                    const habilidades = habilidadesData.habilidades || [];
                    
                    // Adicionar questões
                    questoes.forEach(questao => {
                        const habilidade = habilidades.find(h => h.id === questao.habilidade_id);
                        const card = criarCardQuestao(questao, habilidade);
                        grid.appendChild(card);
                    });
                    
                    // Esconder empty state se houver dados
                    if (emptyState && questoes.length > 0) {
                        emptyState.style.display = 'none';
                    }
                    
                    // Mostrar grid se houver dados
                    if (questoes.length > 0) {
                        grid.style.display = 'grid';
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar dados:', error);
                    // Mesmo sem dados complementares, mostrar questões
                    questoes.forEach(questao => {
                        const card = criarCardQuestao(questao, null);
                        grid.appendChild(card);
                    });
                });
        }

        // Função para criar card de questão
        function criarCardQuestao(questao, habilidade) {
            const div = document.createElement('div');
            div.className = 'questao-card';
            
            const componenteTexto = questao.componente || (habilidade ? habilidade.componente : 'N/A');
            const anoTexto = questao.ano ? `${questao.ano}º ANO` : (habilidade ? `${habilidade.ano}º ANO` : 'N/A');
            const codigoTexto = habilidade ? habilidade.codigo : `Q ${questao.id}`;
            const enunciadoTruncado = questao.enunciado ? 
                (questao.enunciado.length > 100 ? questao.enunciado.substring(0, 100) + '...' : questao.enunciado) : 
                'Sem enunciado';
            
            // Verificar se tem imagem
            let imagemHTML = '';
            if (questao.imagem) {
                // Se a imagem já é uma URL completa (data:image/...), usar diretamente
                // Se não, é base64 puro, então adicionar o prefixo data:image
                let imagemSrc = questao.imagem;
                if (!imagemSrc.startsWith('data:')) {
                    imagemSrc = `data:image/jpeg;base64,${imagemSrc}`;
                }
                
                imagemHTML = `<div class="questao-imagem">
                    <img src="${imagemSrc}" alt="Imagem da questão" onclick="abrirImagemModal('${imagemSrc}')">
                    <div class="imagem-overlay">
                        <i class="fas fa-search-plus"></i>
                    </div>
                </div>`;
            }
            
            div.innerHTML = `
                <div class="questao-header">
                    <div class="questao-codigo">
                        <span class="codigo-badge">${codigoTexto}</span>
                    </div>
                    <div class="questao-actions">
                        <button class="action-btn edit-btn" title="Editar questão" onclick="editarQuestaoById('${questao.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" title="Excluir questão" onclick="excluirQuestaoById('${questao.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div class="questao-info">
                    <div class="questao-meta">
                        <div class="meta-item">
                            <i class="fas fa-graduation-cap"></i>
                            <span>${anoTexto}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-book"></i>
                            <span>${componenteTexto}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-chart-bar"></i>
                            <span>${questao.dificuldade || 'N/A'}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-globe"></i>
                            <span>Questão Nacional</span>
                        </div>
                        ${questao.imagem ? '<div class="meta-item"><i class="fas fa-image"></i><span>Com imagem</span></div>' : ''}
                    </div>
                    
                    ${imagemHTML}
                    
                    <div class="questao-enunciado">
                        ${enunciadoTruncado}
                    </div>
                </div>
            `;
            
            return div;
        }

        // Função para carregar estatísticas
        function carregarEstatisticas() {
            // Carregar total de questões
            fetch('/api/questoes')
                .then(response => response.json())
                .then(data => {
                    const totalQuestoes = data.questoes ? data.questoes.length : 0;
                    animarContador('total-questoes', totalQuestoes);
                    
                    // Contar questões por componente
                    if (data.questoes && data.questoes.length > 0) {
                        contarQuestoesPorComponente(data.questoes);
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar questões:', error);
                    document.getElementById('total-questoes').textContent = '0';
                });
        }

        // Função para contar questões por componente
        function contarQuestoesPorComponente(questoes) {
            let matematicaCount = 0;
            let portuguesCount = 0;

            // Buscar habilidades para mapear questões
            fetch('/api/habilidades')
                .then(response => response.json())
                .then(data => {
                    const habilidades = data.habilidades || [];
                    
                    questoes.forEach(questao => {
                        const habilidade = habilidades.find(h => h.id === questao.habilidade_id);
                        if (habilidade) {
                            const componente = habilidade.componente.toLowerCase();
                            
                            if (componente.includes('matemática')) {
                                matematicaCount++;
                            } else if (componente.includes('português') || componente.includes('língua portuguesa')) {
                                portuguesCount++;
                            }
                        }
                    });

                    // Atualizar contadores no header
                    animarContador('matematica-count', matematicaCount);
                    animarContador('portugues-count', portuguesCount);
                })
                .catch(error => console.error('Erro ao processar habilidades:', error));
        }

        // Função para animar contadores
        function animarContador(elementId, valorFinal) {
            const elemento = document.getElementById(elementId);
            if (!elemento) return;
            
            const valorInicial = 0;
            const duracao = 1000;
            const incremento = valorFinal / (duracao / 16);
            
            let valorAtual = valorInicial;
            
            const timer = setInterval(() => {
                valorAtual += incremento;
                if (valorAtual >= valorFinal) {
                    elemento.textContent = valorFinal;
                    clearInterval(timer);
                } else {
                    elemento.textContent = Math.floor(valorAtual);
                }
            }, 16);
        }

        // Configurar busca
        function configurarBusca() {
            const searchInput = document.getElementById('search-questoes');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const cards = document.querySelectorAll('.questao-card');
                    
                    cards.forEach(card => {
                        const codigo = card.querySelector('.codigo-badge').textContent.toLowerCase();
                        const meta = card.querySelectorAll('.meta-item span');
                        const enunciado = card.querySelector('.questao-enunciado').textContent.toLowerCase();
                        
                        let encontrou = codigo.includes(searchTerm) || enunciado.includes(searchTerm);
                        
                        // Buscar também nas meta informações
                        meta.forEach(item => {
                            if (item.textContent.toLowerCase().includes(searchTerm)) {
                                encontrou = true;
                            }
                        });
                        
                        if (encontrou) {
                            card.style.display = '';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            }
        }

        // Configurar formulário
        function configurarFormulario() {
            const form = document.getElementById('questao-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    salvarQuestao();
                });
            }
        }

        // Configurar importação
        function configurarImportacao() {
            const formImportar = document.getElementById('form-importar-excel');
            const feedbackImport = document.getElementById('import-feedback');
            
            if (formImportar) {
                formImportar.addEventListener('submit', function(e) {
                    e.preventDefault();
                    importarExcel(feedbackImport);
                });
            }
        }

        // Função para carregar habilidades no select
        function carregarHabilidades() {
            const selectHabilidade = document.getElementById('habilidade');
            if (!selectHabilidade) return;

            fetch('/api/habilidades')
                .then(response => response.json())
                .then(data => {
                    if (data.habilidades) {
                        data.habilidades.forEach(habilidade => {
                            const option = document.createElement('option');
                            option.value = habilidade.id;
                            option.textContent = `${habilidade.codigo} - ${habilidade.componente}`;
                            selectHabilidade.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar habilidades:', error);
                });
        }

        // Função carregarEscolas() removida - questões agora são compartilhadas nacionalmente

        // Função para salvar questão
        async function salvarQuestao() {
            const form = document.getElementById('questao-form');
            const formData = new FormData(form);
            
            // Se há uma imagem selecionada, usar FormData para upload
            const imagemFile = document.getElementById('imagem').files[0];
            const temImagem = imagemFile != null;

            try {
                let response;
                let mensagemSucesso;
                
                if (window.questaoEditando) {
                    // Para edição, usar FormData se há imagem, senão JSON
                    if (temImagem) {
                        response = await fetch(`/api/questoes/${window.questaoEditando}`, {
                            method: 'PUT',
                            body: formData
                        });
                    } else {
                        const questao = {
                            ano: formData.get('ano'),
                            habilidade_id: formData.get('habilidade_id'),
                            componente: formData.get('componente'),
                            enunciado: formData.get('enunciado'),
                            alternativa_a: formData.get('alternativa_a'),
                            alternativa_b: formData.get('alternativa_b'),
                            alternativa_c: formData.get('alternativa_c'),
                            alternativa_d: formData.get('alternativa_d'),
                            resposta_correta: formData.get('resposta_correta'),
                            dificuldade: formData.get('dificuldade')
                        };
                        response = await fetch(`/api/questoes/${window.questaoEditando}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(questao)
                        });
                    }
                    mensagemSucesso = 'Questão atualizada com sucesso!';
                } else {
                    // Para criação, usar FormData se há imagem, senão JSON
                    if (temImagem) {
                        response = await fetch('/api/questoes', {
                            method: 'POST',
                            body: formData
                        });
                    } else {
                        const questao = {
                            ano: formData.get('ano'),
                            habilidade_id: formData.get('habilidade_id'),
                            componente: formData.get('componente'),
                            enunciado: formData.get('enunciado'),
                            alternativa_a: formData.get('alternativa_a'),
                            alternativa_b: formData.get('alternativa_b'),
                            alternativa_c: formData.get('alternativa_c'),
                            alternativa_d: formData.get('alternativa_d'),
                            resposta_correta: formData.get('resposta_correta'),
                            dificuldade: formData.get('dificuldade')
                        };
                        response = await fetch('/api/questoes', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(questao)
                        });
                    }
                    mensagemSucesso = 'Questão criada com sucesso!';
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Sucesso!', mensagemSucesso);
                    
                    // Resetar formulário e preview
                    form.reset();
                    removerImagem();
                    window.questaoEditando = null;
                    
                    const submitBtn = document.querySelector('#questao-form button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Questão';
                    }
                    
                    const cancelBtn = document.getElementById('btn-cancelar-edicao');
                    if (cancelBtn) {
                        cancelBtn.style.display = 'none';
                    }
                    
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showError('Erro', data.error || 'Erro ao salvar questão');
                }
            } catch (error) {
                console.error('Erro ao salvar questão:', error);
                showError('Erro', 'Erro ao salvar questão. Tente novamente');
            }
        }

        // Função para editar questão
        async function editarQuestaoById(questaoId) {
            try {
                const response = await fetch('/api/questoes');
                const data = await response.json();
                
                if (!data.questoes) {
                    showError('Erro', 'Não foi possível buscar as questões');
                    return;
                }
                
                const questao = data.questoes.find(q => q.id == questaoId);
                if (!questao) {
                    showError('Erro', 'Questão não encontrada');
                    return;
                }
                
                // Preencher formulário
                document.getElementById('ano').value = questao.ano || '';
                document.getElementById('habilidade').value = questao.habilidade_id || '';
                document.getElementById('componente').value = questao.componente || '';
                document.getElementById('enunciado').value = questao.enunciado || '';
                document.getElementById('alternativa_a').value = questao.alternativa_a || '';
                document.getElementById('alternativa_b').value = questao.alternativa_b || '';
                document.getElementById('alternativa_c').value = questao.alternativa_c || '';
                document.getElementById('alternativa_d').value = questao.alternativa_d || '';
                document.getElementById('resposta_correta').value = questao.resposta_correta || '';
                document.getElementById('dificuldade').value = questao.dificuldade || '';
                
                window.questaoEditando = questao.id;
                
                const submitBtn = document.querySelector('#questao-form button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-edit"></i> Atualizar Questão';
                }
                
                const cancelBtn = document.getElementById('btn-cancelar-edicao');
                if (cancelBtn) {
                    cancelBtn.style.display = 'block';
                }
                
                document.querySelector('.actions-section').scrollIntoView({ 
                    behavior: 'smooth' 
                });
                
                document.getElementById('enunciado').focus();
                
            } catch (error) {
                console.error('Erro ao carregar questão para edição:', error);
                showError('Erro', 'Erro ao carregar dados da questão para edição');
            }
        }

        // Função para excluir questão
        async function excluirQuestaoById(questaoId) {
            if (!confirm('Tem certeza que deseja excluir esta questão?\n\nEsta ação não pode ser desfeita.')) {
                return;
            }
            
            try {
                const deleteResponse = await fetch(`/api/questoes/${questaoId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await deleteResponse.json();
                
                if (result.success) {
                    showSuccess('Sucesso!', 'Questão excluída com sucesso');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    showError('Erro', result.error || 'Erro ao excluir questão');
                }
                
            } catch (error) {
                console.error('Erro ao excluir questão:', error);
                showError('Erro', 'Erro ao excluir questão. Tente novamente');
            }
        }

        // Função para cancelar edição
        function cancelarEdicao() {
            document.getElementById('questao-form').reset();
            removerImagem();
            window.questaoEditando = null;
            
            const submitBtn = document.querySelector('#questao-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Questão';
            }
            
            const cancelBtn = document.getElementById('btn-cancelar-edicao');
            if (cancelBtn) {
                cancelBtn.style.display = 'none';
            }
        }

        // Função para importar Excel
        function importarExcel(feedbackElement) {
            feedbackElement.innerHTML = '';
            const arquivo = document.getElementById('arquivo-excel').files[0];
            
            if (!arquivo) {
                mostrarFeedback(feedbackElement, 'Selecione um arquivo Excel', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('arquivo', arquivo);
            
            mostrarFeedback(feedbackElement, 'Processando arquivo...', 'loading');
            
            fetch('/api/questoes/importar', {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    mostrarFeedback(feedbackElement, data.message, 'success');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    mostrarFeedback(feedbackElement, data.error || 'Erro ao importar.', 'error');
                }
            })
            .catch(() => {
                mostrarFeedback(feedbackElement, 'Erro ao processar requisição.', 'error');
            });
        }

        // Função auxiliar para mostrar feedback
        function mostrarFeedback(elemento, mensagem, tipo) {
            elemento.className = `feedback-message ${tipo}`;
            const icone = tipo === 'success' ? 'fas fa-check-circle' : 
                         tipo === 'error' ? 'fas fa-exclamation-circle' : 
                         'fas fa-spinner fa-spin';
            elemento.innerHTML = `<i class="${icone}"></i> ${mensagem}`;
        }

        // Configurar upload de imagem
        function configurarUploadImagem() {
            const inputImagem = document.getElementById('imagem');
            if (inputImagem) {
                inputImagem.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Validar tipo de arquivo
                        if (!file.type.startsWith('image/')) {
                            showError('Erro', 'Por favor, selecione apenas arquivos de imagem');
                            e.target.value = '';
                            return;
                        }

                        // Validar tamanho (5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            showError('Erro', 'A imagem deve ter no máximo 5MB');
                            e.target.value = '';
                            return;
                        }

                        // Mostrar preview
                        mostrarPreviewImagem(file);
                    }
                });
            }
        }

        // Mostrar preview da imagem
        function mostrarPreviewImagem(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewContainer = document.getElementById('image-preview');
                const previewImg = document.getElementById('preview-img');
                const uploadLabel = document.querySelector('.image-upload-label');
                
                previewImg.src = e.target.result;
                previewContainer.style.display = 'block';
                uploadLabel.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        // Remover imagem
        function removerImagem() {
            const inputImagem = document.getElementById('imagem');
            const previewContainer = document.getElementById('image-preview');
            const uploadLabel = document.querySelector('.image-upload-label');
            
            inputImagem.value = '';
            previewContainer.style.display = 'none';
            uploadLabel.style.display = 'flex';
        }

        // Abrir modal de imagem
        function abrirImagemModal(imagemUrl) {
            const modal = document.getElementById('imagemModal');
            const modalImg = document.getElementById('imagemModalImg');
            
            modalImg.src = imagemUrl;
            modal.style.display = 'flex';
            
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }

        // Fechar modal de imagem
        function fecharImagemModal() {
            const modal = document.getElementById('imagemModal');
            
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
    </script>
{% endblock %} 